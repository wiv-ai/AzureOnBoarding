# CSP Azure Lighthouse Mass Onboarding

This solution enables CSP (Cloud Solution Provider) partners to mass onboard all their customers to Azure Lighthouse for centralized monitoring and cost management - **without any customer involvement**.

## 🎯 What This Does

- Creates a single service principal in your CSP tenant
- Uses AOBO (Admin On Behalf Of) privileges to automatically deploy Lighthouse
- Grants your service principal **limited** permissions (Cost Management Reader + Monitoring Reader)
- Processes all customers in parallel for speed
- No customer action required - fully automated

## 📋 Prerequisites

1. **CSP Partner Status**: You must be a Microsoft CSP partner with active customer relationships
2. **Azure CLI**: Install [Azure CLI](https://docs.microsoft.com/en-us/cli/azure/install-azure-cli)
3. **AOBO Access**: CSP admin privileges to access customer tenants
4. **Service Principal**: An app registration in your CSP tenant (use your existing startup.sh or create manually)

## 🚀 The Complete Flow

### Step 0: Prerequisites - Create App Registration (One Time)

Before using these scripts, ensure you have an app registration in your CSP tenant:

```bash
# Option A: Use your existing startup.sh script
../startup.sh  # Creates "wiv_account" app registration

# Option B: Create manually in Azure Portal
# Go to Azure AD > App registrations > New registration
# Name: wiv_account
```

### Step 1: Fetch Your Service Principal IDs

Run this in your CSP/managing tenant to get your actual IDs:

```bash
cd csp-lighthouse-onboarding
chmod +x get-app-ids.sh
./get-app-ids.sh

# This will:
# 1. Find your existing "wiv_account" app registration
# 2. Fetch your actual CSP Tenant ID
# 3. Fetch your actual App (Client) ID  
# 4. Fetch your actual Service Principal Object ID
# 5. Ask if you want to save to lighthouse-config.env
# 6. Answer 'y' to create the config file
```

**This creates `lighthouse-config.env` with your REAL values:**
```bash
CSP_TENANT_ID="12345678-1234-1234-1234-123456789012"  # Your actual tenant ID
CSP_APP_ID="aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"     # Your actual app ID
CSP_SP_OBJECT_ID="bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbb" # Your actual SP Object ID
CSP_APP_NAME="wiv_account"
```

### Step 2: Prepare Customer List

Create a `customers.txt` file with your customers:

```bash
# Format: CustomerName[TAB]TenantID
Contoso Corp	aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa
Fabrikam Inc	bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbbbb
```

**To get customer list from Partner Center:**
```powershell
# Using Partner Center PowerShell
Connect-PartnerCenter
Get-PartnerCustomer | Select-Object Name, TenantId | Export-Csv customers.csv

# Convert CSV to tab-delimited format for customers.txt
```

### Step 3: Run Mass Onboarding

The script automatically uses the values from `lighthouse-config.env`:

```bash
chmod +x parallel-mass-onboard.sh

# Test with dry run first
./parallel-mass-onboard.sh --dry-run

# Run actual deployment (uses your IDs from lighthouse-config.env)
./parallel-mass-onboard.sh

# The script will:
# 1. Load your IDs from lighthouse-config.env
# 2. Use your CSP_TENANT_ID and CSP_SP_OBJECT_ID
# 3. Deploy Lighthouse to all customers
# 4. Grant your SP the two reader roles
```

## 🔄 How Variables Flow Through the System

```
1. get-app-ids.sh
   ↓ (fetches from Azure AD)
   ↓ (creates lighthouse-config.env)
   
2. lighthouse-config.env
   ├── CSP_TENANT_ID="your-actual-value"
   ├── CSP_APP_ID="your-actual-value"
   └── CSP_SP_OBJECT_ID="your-actual-value"
   ↓ (sourced automatically)
   
3. parallel-mass-onboard.sh
   ↓ (uses variables for deployment)
   
4. Lighthouse Deployment
   └── Your SP gets access to all customers
```

## 📁 File Structure

```
csp-lighthouse-onboarding/
├── get-app-ids.sh              # Fetches your service principal IDs
├── parallel-mass-onboard.sh    # Mass deployment script (uses lighthouse-config.env)
├── lighthouse-template.json    # ARM template for Lighthouse
├── lighthouse-config.env       # AUTO-GENERATED by get-app-ids.sh with your IDs
├── parameters.json             # Template for manual deployment (has placeholders)
├── customers.txt               # Your customer list (you create this)
├── role-definitions.json       # Reference for Azure role IDs
├── customers-sample.txt        # Sample customer file format
├── .gitignore                  # Excludes sensitive files
└── README.md                   # This file
```

## 🔧 Configuration

### Environment Variables (lighthouse-config.env)

**This file is AUTO-GENERATED when you run `get-app-ids.sh`**

You don't need to manually edit these - they're fetched from your Azure AD:

```bash
CSP_TENANT_ID="12345678-1234-1234-1234-123456789012"  # Auto-fetched
CSP_APP_ID="aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"     # Auto-fetched
CSP_SP_OBJECT_ID="bbbbbbbb-bbbb-bbbb-bbbb-bbbbbbbbbb" # Auto-fetched
CSP_APP_NAME="wiv_account"                            # Auto-fetched
```

### Manual Override (Optional)

If you need to manually set values:

```bash
# Option 1: Edit the generated file
nano lighthouse-config.env

# Option 2: Create manually
cat > lighthouse-config.env << EOF
CSP_TENANT_ID="your-tenant-id"
CSP_APP_ID="your-app-id"
CSP_SP_OBJECT_ID="your-sp-object-id"
CSP_APP_NAME="wiv_account"
EOF
```

### Customizing Permissions

Edit `lighthouse-template.json` to modify permissions. Default roles:

| Role | ID | Purpose |
|------|-----|---------|
| Cost Management Reader | 72fafb9e-0641-4937-9268-a91bfd8191a3 | Read cost and billing data |
| Monitoring Reader | 43d0d8ad-25c7-4714-9337-8ba259a9fe05 | Read metrics and logs |

See `role-definitions.json` for more built-in roles.

## 🔄 How It Works

1. **Authentication**: Script uses your CSP AOBO privileges
2. **Parallel Processing**: Deploys to multiple customers simultaneously
3. **Lighthouse Deployment**: Creates delegation in each customer subscription
4. **Logging**: Tracks success/failure for each customer
5. **Result**: Your single SP can access all customer resources

## 📊 Monitoring Progress

During deployment:
- Real-time console output shows progress
- `logs/onboarding_status_TIMESTAMP.csv` - Detailed status
- `logs/onboarding_errors_TIMESTAMP.log` - Error details

View results:
```bash
# Show status in table format
cat logs/onboarding_status_*.csv | column -t -s ','

# Check for errors
cat logs/onboarding_errors_*.log
```

## 🔍 Verification

After deployment, verify access:

```bash
# List all accessible subscriptions
az account list --all --output table

# Test access to specific customer
az account set --subscription "customer-subscription-id"
az cost management query --type ActualCost --timeframe MonthToDate
```

In Azure Portal:
1. Go to Azure Lighthouse > Service providers
2. You should see all delegations
3. Switch context to access customer resources

## ⚠️ Troubleshooting

### Common Issues

| Issue | Solution |
|-------|----------|
| "lighthouse-config.env not found" | Run `./get-app-ids.sh` first and answer 'y' to save |
| "Application 'wiv_account' not found" | Create it using your startup.sh or manually in Azure |
| "Not logged in to Azure" | Run `az login` first |
| "AOBO access failed" | Verify CSP relationship is active |
| "No subscriptions found" | Customer may not have Azure subscriptions |
| "Deployment failed" | Check if Lighthouse is already configured |

### Retry Failed Deployments

```bash
# Extract failed customers
grep FAILED logs/onboarding_status_*.csv | cut -d',' -f3 > failed-tenants.txt

# Create new customers.txt with only failed ones
# Then rerun the deployment
```

## 🔒 Security Considerations

1. **Minimal Permissions**: Only Cost and Monitoring Reader (no write access)
2. **Audit Trail**: All access is logged in both tenants
3. **Revocable**: Customers can remove delegation anytime
4. **No Credentials**: No secrets stored in customer tenants

## 📈 Scaling

| Customers | Estimated Time | Recommended Batch Size |
|-----------|---------------|------------------------|
| 1-10 | 2-5 minutes | 5 |
| 10-50 | 5-10 minutes | 10 |
| 50-100 | 10-20 minutes | 15 |
| 100-500 | 30-60 minutes | 20 |
| 500+ | 1-2 hours | 25 |

## 🤝 CSP vs Direct Comparison

| Aspect | CSP with AOBO + Lighthouse | Direct Customer Deployment |
|--------|---------------------------|---------------------------|
| Customer Action | None | Must run deployment |
| Deployment Speed | Minutes (automated) | Days/weeks (coordination) |
| Scalability | Excellent (parallel) | Poor (manual) |
| Credential Management | Single SP | Multiple credentials |
| Maintenance | Centralized | Per-customer |

## 📝 Advanced Usage

### Exclude Specific Customers

```bash
# Create exclude list
echo "tenant-id-to-exclude" > exclude-list.txt

# Run with exclusions
./parallel-mass-onboard.sh --exclude-file exclude-list.txt
```

### Custom Role Assignments

Modify the `authorizations` array in `lighthouse-template.json`:

```json
{
    "principalId": "your-sp-object-id",
    "roleDefinitionId": "custom-role-id",
    "principalIdDisplayName": "Display Name"
}
```

### Integration with CI/CD

```yaml
# Azure DevOps Pipeline example
- script: |
    cd csp-lighthouse-onboarding
    ./get-app-ids.sh
    ./parallel-mass-onboard.sh --batch-size 20
  displayName: 'Deploy Lighthouse to all CSP customers'
```

## 📚 Additional Resources

- [Azure Lighthouse Documentation](https://docs.microsoft.com/en-us/azure/lighthouse/)
- [CSP Partner Documentation](https://docs.microsoft.com/en-us/partner-center/)
- [Azure RBAC Roles](https://docs.microsoft.com/en-us/azure/role-based-access-control/built-in-roles)

## 🆘 Support

For issues or questions:
1. Check the error logs in `logs/` directory
2. Verify CSP relationship status in Partner Center
3. Ensure Azure Lighthouse is available in customer regions

## 📄 License

This solution is provided as-is for CSP partners to streamline Azure Lighthouse onboarding.

---

**Note**: This solution uses CSP AOBO privileges responsibly to deploy minimal required permissions via Azure Lighthouse, ensuring security while eliminating customer friction in the onboarding process.